<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pothole Detection & Complaints Portal - Tools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <!-- AOS Animation Library -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <!-- Link to your custom CSS (optional) -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="app-root"></div>

    {% raw %}
    <script type="text/babel">
        // Main App Component for Tools Page
        const ToolsApp = () => {
            const [activeTab, setActiveTab] = React.useState('detection');
            const navbarRef = React.useRef(null);

            // State for Pothole Detection Form
            const [potholeLoading, setPotholeLoading] = React.useState(false);
            const [potholeResult, setPotholeResult] = React.useState(null);
            const [potholeError, setPotholeError] = React.useState(null);
            const [annotatedImageSrc, setAnnotatedImageSrc] = React.useState('');

            // State for Complaint Form
            const [complaintLoading, setComplaintLoading] = React.useState(false);
            const [complaintResult, setComplaintResult] = React.useState(null);
            const [complaintError, setComplaintError] = React.useState(null);

            // State for Stats
            const [stats, setStats] = React.useState({
                total_potholes: '-', high_priority_count: '-', medium_priority_count: '-',
                low_priority_count: '-', last_updated: '-'
            });

            // --- Effects ---
            React.useEffect(() => {
                // Initialize AOS animations
                AOS.init({
                    duration: 1000,
                    once: true,
                    offset: 100
                });

                // Navbar scroll effect
                const handleScroll = () => {
                    if (navbarRef.current) {
                        if (window.scrollY > 10) {
                            navbarRef.current.classList.add('shadow-sm');
                        } else {
                            navbarRef.current.classList.remove('shadow-sm');
                        }
                    }
                };
                window.addEventListener('scroll', handleScroll);

                // Fetch initial stats when component mounts
                fetchPotholeStats();

                // Cleanup scroll listener
                return () => window.removeEventListener('scroll', handleScroll);
            }, []); // Empty dependency array: runs only once on mount


            // --- Helper Functions ---
            // scrollToSection might not be needed here unless linking within this page
            const scrollToSection = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    const offset = 100; // Adjust as needed
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            };

            const fetchPotholeStats = () => {
                fetch('/pothole_stats')
                    .then(res => {
                        if (!res.ok) throw new Error('Failed to fetch stats');
                        return res.json();
                    })
                    .then(data => {
                        setStats({
                            total_potholes: data.total_potholes ?? '-',
                            high_priority_count: data.high_priority_count ?? '-',
                            medium_priority_count: data.medium_priority_count ?? '-',
                            low_priority_count: data.low_priority_count ?? '-',
                            last_updated: data.last_updated
                                ? new Date(data.last_updated).toLocaleString()
                                : '-'
                        });
                    })
                    .catch((err) => {
                        console.error("Error fetching pothole stats:", err);
                         setStats({ // Reset to default on error
                            total_potholes: '-', high_priority_count: '-', medium_priority_count: '-',
                            low_priority_count: '-', last_updated: 'Error loading'
                         });
                    });
            };

            // --- Form Handlers ---
            const handlePotholeSubmit = (event) => {
                event.preventDefault(); // Prevent default page refresh!
                setPotholeLoading(true);
                setPotholeResult(null);
                setPotholeError(null);
                setAnnotatedImageSrc('');

                const form = event.target;
                const formData = new FormData(form);

                fetch('/detect_pothole', {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                    if (!response.ok) {
                        let errorMsg = `Detection failed with status ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (jsonError) { /* Keep status-based error */ }
                        throw new Error(errorMsg);
                    }
                    return response.json();
                })
                .then(data => {
                    setPotholeResult(data.result);
                    setAnnotatedImageSrc('data:image/jpeg;base64,' + data.annotated_image_b64);
                    fetchPotholeStats(); // Refresh stats after successful detection
                })
                .catch(err => {
                    setPotholeError(err.message);
                })
                .finally(() => {
                    setPotholeLoading(false);
                });
            };

            const handleComplaintSubmit = (event) => {
                event.preventDefault(); // Prevent default page refresh!
                setComplaintLoading(true);
                setComplaintResult(null);
                setComplaintError(null);

                const form = event.target;
                const formData = new FormData(form);

                fetch('/raise_complaint', {
                    method: 'POST',
                    body: formData
                })
                .then(async response => {
                     if (!response.ok) {
                         let errorMsg = `Submission failed with status ${response.status}`;
                         try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (jsonError) { /* Keep status-based error */ }
                        throw new Error(errorMsg);
                    }
                    return response.json();
                })
                .then(data => {
                    setComplaintResult(data.message || 'Complaint submitted successfully.');
                    form.reset(); // Optionally reset the form fields on success
                })
                .catch(err => {
                    setComplaintError(err.message);
                })
                .finally(() => {
                    setComplaintLoading(false);
                });
            };


            // --- Render Logic ---
            return (
                <React.Fragment>
                    {/* Navigation */}
                    <nav className="navbar navbar-expand-lg navbar-light sticky-top" ref={navbarRef}>
                        <div className="container">
                            <a className="navbar-brand" href="/">
                                <i className="bi bi-person-check me-2" style={{ color: "#6f42c1" }}></i>
                                eNivaran
                            </a>
                            <button className="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                                <span className="navbar-toggler-icon"></span>
                            </button>
                            <div className="collapse navbar-collapse justify-content-end" id="navbarNav">
                                <ul className="navbar-nav">
                                    <li className="nav-item">
                                        <a className="nav-link" href="/">Home</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="/complaints">Complaints</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="/my_complaints">My Complaints</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link active" href="/tools">Tools</a>
                                    </li>
                                    <li className="nav-item">
                                        <a className="nav-link" href="/logout">Logout</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </nav>

                    {/* Tools Section */}
                    <section className="container my-5" id="tools-section">
                        <div className="text-center mb-5" data-aos="fade-up">
                            <h2 className="display-5 fw-bold mb-3">Our Tools</h2>
                            <p className="lead text-muted mx-auto" style={{maxWidth: "700px"}}>
                                Access our pothole detection algorithm and civic complaint system to help improve road conditions in your area.
                            </p>

                            <div className="content-tabs d-inline-flex mt-4">
                                <div
                                    className={`content-tab ${activeTab === 'detection' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('detection')}
                                >
                                    <i className="bi bi-search me-2"></i>
                                    Pothole Detection
                                </div>
                                <div
                                    className={`content-tab ${activeTab === 'complaint' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('complaint')}
                                >
                                    <i className="bi bi-flag-fill me-2"></i>
                                    Raise Complaint
                                </div>
                            </div>
                        </div>

                       
                        {/* Pothole Detection Form */}
                        {activeTab === 'detection' && (
                            <div className="row mb-5" data-aos="fade-up" key="detection-form">
                                <div className="col-lg-10 col-xl-8 mx-auto">
                                    <div className="card shadow-sm">
                                        <div className="card-body p-4 p-md-5">
                                            <h3 className="card-title mb-4"><i className="bi bi-camera-fill me-2"></i>Pothole Detection</h3>
                                            <form id="pothole-form" encType="multipart/form-data" autoComplete="off" onSubmit={handlePotholeSubmit}>
                                                <div className="mb-3">
                                                    <label htmlFor="image" className="form-label fw-bold">Upload Road Image</label>
                                                    <input className="form-control form-control-lg" type="file" id="image" name="image" accept="image/*" required />
                                                    <div className="form-text">Supported formats: JPG, JPEG, PNG, WebP</div>
                                                </div>
                                                <button type="submit" className="btn btn-primary btn-lg w-100" disabled={potholeLoading}>
                                                    {potholeLoading ? (
                                                        <>
                                                            <span className="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                            Detecting...
                                                        </>
                                                    ) : (
                                                        <> <i className="bi bi-search me-2"></i> Check for Pothole </>
                                                    )}
                                                </button>
                                            </form>
                                            {potholeResult && !potholeLoading && (
                                                <div id="result-section" className="mt-4">
                                                    <hr/>
                                                    <h5>Detection Result</h5>
                                                    <pre id="result-json" className="bg-light p-3 rounded small">{JSON.stringify(potholeResult, null, 2)}</pre>
                                                    <h6 className="mt-3">Annotated Image</h6>
                                                    <img id="annotated-image" src={annotatedImageSrc} alt="Annotated Result" className="img-fluid border rounded shadow-sm" />
                                                </div>
                                            )}
                                            {potholeError && !potholeLoading && (
                                                <div id="error-section" className="alert alert-danger mt-4">
                                                    <i className="bi bi-exclamation-triangle-fill me-2"></i> {potholeError}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Complaint Form */}
                        {activeTab === 'complaint' && (
                            <div className="row mb-5" data-aos="fade-up" key="complaint-form">
                                <div className="col-lg-10 col-xl-8 mx-auto">
                                    <div className="card shadow-sm">
                                        <div className="card-body p-4 p-md-5">
                                            <h3 className="card-title mb-4"><i className="bi bi-flag-fill me-2"></i>Raise Civic Complaint</h3>
                                            <form id="complaint-form" encType="multipart/form-data" autoComplete="off" onSubmit={handleComplaintSubmit}>
                                                <div className="mb-3">
                                                    <label htmlFor="complaint-text" className="form-label fw-bold">Complaint Description</label>
                                                    <textarea className="form-control" id="complaint-text" name="text" rows="3" required placeholder="Describe the issue clearly..."></textarea>
                                                </div>
                                                <div className="mb-3">
                                                    <label htmlFor="issue-type" className="form-label fw-bold">Issue Type</label>
                                                    <input className="form-control" type="text" id="issue-type" name="issue_type" placeholder="e.g., Pothole, Damaged Sign, Streetlight Out" required />
                                                </div>
                                                 <div className="row g-3 mb-3">
                                                    <div className="col-md-6">
                                                        <label htmlFor="street" className="form-label fw-bold">Street Name</label>
                                                        <input className="form-control" type="text" id="street" name="street" required />
                                                    </div>
                                                    <div className="col-md-6">
                                                        <label htmlFor="city" className="form-label fw-bold">City Name</label>
                                                        <input className="form-control" type="text" id="city" name="city" required />
                                                    </div>
                                                    <div className="col-md-6">
                                                        <label htmlFor="state" className="form-label fw-bold">State</label>
                                                        <input className="form-control" type="text" id="state" name="state" required />
                                                    </div>
                                                    <div className="col-md-6">
                                                        <label htmlFor="zipcode" className="form-label fw-bold">Zip Code</label>
                                                        <input className="form-control" type="text" id="zipcode" name="zipcode" required />
                                                    </div>
                                                </div>
                                                <div className="mb-4">
                                                    <label htmlFor="complaint-image" className="form-label fw-bold">Upload Image Evidence</label>
                                                    <input className="form-control" type="file" id="complaint-image" name="image" accept="image/*" required />
                                                    <div className="form-text">Supported formats: JPG, JPEG, PNG, WebP</div>
                                                </div>
                                                <button type="submit" className="btn btn-success btn-lg w-100" disabled={complaintLoading}>
                                                    {complaintLoading ? (
                                                        <>
                                                            <span className="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                                            Submitting...
                                                        </>
                                                    ) : (
                                                        <> <i className="bi bi-send-fill me-2"></i> Submit Complaint </>
                                                    )}
                                                </button>
                                            </form>
                                            {complaintResult && !complaintLoading && (
                                                <div id="complaint-result-section" className="mt-4">
                                                     <hr/>
                                                    <div className="alert alert-success d-flex align-items-center" role="alert">
                                                        <i className="bi bi-check-circle-fill me-2"></i>
                                                        <div id="complaint-result-message">{complaintResult}</div>
                                                    </div>
                                                </div>
                                            )}
                                            {complaintError && !complaintLoading && (
                                                <div id="complaint-error-section" className="alert alert-danger mt-4">
                                                     <i className="bi bi-exclamation-triangle-fill me-2"></i> {complaintError}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </section>

                    {/* Footer */}
                    <footer>
                        <div className="container">
                            <div className="row">
                                <div className="col-lg-4 col-md-6 mb-4 mb-lg-0">
                                    <div className="footer-brand d-flex align-items-center mb-3">
                                        <i className="bi bi-person-check me-2" style={{ color: "#6f42c1" }}></i>
                                        eNivaran
                                    </div>
                                    <p className="footer-text">
                                        AI-powered road safety and civic issue reporting for smarter cities.
                                        Building better communities through technology and citizen participation.
                                    </p>
                                     <div className="social-links mt-4">
                                        <a href="#" className="social-link me-3"><i className="bi bi-facebook"></i></a>
                                        <a href="#" className="social-link me-3"><i className="bi bi-twitter"></i></a>
                                        <a href="#" className="social-link me-3"><i className="bi bi-instagram"></i></a>
                                        <a href="#" className="social-link"><i className="bi bi-linkedin"></i></a>
                                    </div>
                                </div>

                                <div className="col-lg-2 col-md-6 mb-4 mb-lg-0">
                                    <div className="footer-links">
                                        <h5>Navigation</h5>
                                        <ul>
                                             {/* Updated links to point to index page sections or the tools page */}
                                             <li><a href="/#home">Home</a></li>
                                             <li><a href="/#features">Features</a></li>
                                             <li><a href="/#how-it-works">How It Works</a></li>
                                             <li><a href="/tools">Tools</a></li>
                                        </ul>
                                    </div>
                                </div>

                                <div className="col-lg-3 col-md-6 mb-4 mb-lg-0">
                                    <div className="footer-links">
                                        <h5>Resources</h5>
                                        <ul>
                                            <li><a href="#">API Documentation</a></li>
                                            <li><a href="#">Developer Resources</a></li>
                                            <li><a href="#">Data Privacy</a></li>
                                            <li><a href="#">Terms of Service</a></li>
                                        </ul>
                                    </div>
                                </div>

                                <div className="col-lg-3 col-md-6 mb-4 mb-lg-0">
                                    <div className="footer-links">
                                        <h5>Contact</h5>
                                        <ul className="list-unstyled">
                                            <li className="mb-2"><a href="mailto:info@enivaran.com"><i className="bi bi-envelope me-2"></i>info@enivaran.com</a></li>
                                            <li className="mb-2"><a href="tel:+15551234567"><i className="bi bi-telephone me-2"></i>(555) 123-4567</a></li>
                                            <li><a href="#"><i className="bi bi-geo-alt me-2"></i>123 Tech Lane, Smart City</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div className="copyright mt-5">
                                <small>
                                    <i className="bi bi-c-circle me-1"></i> {new Date().getFullYear()} eNivaran | Built with React, Bootstrap, Flask & AI
                                </small>
                            </div>
                        </div>
                    </footer>
                </React.Fragment>
            );
        }

        // Render Tools App component
        ReactDOM.render(<ToolsApp />, document.getElementById('app-root'));
    </script>
    {% endraw %}

    <!-- Bootstrap 5 JS Bundle (needed for toggler, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
